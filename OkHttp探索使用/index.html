<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>OkHttp探索使用 | Garvin 杂记</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="Okhttp">
    <meta name="description" content="为Android和Java应用设计并且支持SPDY和HTTP请求的客户端。 CallsRequests(请求)每个HTTP请求包含了URL、METHOD和一系列头部信息。当然，头部也可以包含指定类型的数据流。 Responses(响应)带有状态码，Header和一些可选信息的对请求的响应。 Calls(调用)调用能够以Synchronous(同步)或者Asynchronous(异步)的形式被执行:">
<meta name="keywords" content="Okhttp">
<meta property="og:type" content="article">
<meta property="og:title" content="OkHttp探索使用">
<meta property="og:url" content="https://hjw541988478.github.io/OkHttp探索使用/index.html">
<meta property="og:site_name" content="Garvin 杂记">
<meta property="og:description" content="为Android和Java应用设计并且支持SPDY和HTTP请求的客户端。 CallsRequests(请求)每个HTTP请求包含了URL、METHOD和一系列头部信息。当然，头部也可以包含指定类型的数据流。 Responses(响应)带有状态码，Header和一些可选信息的对请求的响应。 Calls(调用)调用能够以Synchronous(同步)或者Asynchronous(异步)的形式被执行:">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://hjw541988478.github.io/OkHttp探索使用/okhttp_interceptors.png">
<meta property="og:updated_time" content="2018-08-18T12:25:09.957Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="OkHttp探索使用">
<meta name="twitter:description" content="为Android和Java应用设计并且支持SPDY和HTTP请求的客户端。 CallsRequests(请求)每个HTTP请求包含了URL、METHOD和一系列头部信息。当然，头部也可以包含指定类型的数据流。 Responses(响应)带有状态码，Header和一些可选信息的对请求的响应。 Calls(调用)调用能够以Synchronous(同步)或者Asynchronous(异步)的形式被执行:">
<meta name="twitter:image" content="https://hjw541988478.github.io/OkHttp探索使用/okhttp_interceptors.png">
    
        <link rel="alternate" type="application/atom+xml" title="Garvin 杂记" href="/atom.xml">
    
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Garvin</h5>
          <a href="mailto:huangjiawendanny@gmail.com" title="huangjiawendanny@gmail.com" class="mail">huangjiawendanny@gmail.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                存档
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                标签
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                分类
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">OkHttp探索使用</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">OkHttp探索使用</h1>
        <h5 class="subtitle">
            
                <time datetime="2015-09-16T12:12:00.000Z" itemprop="datePublished" class="page-time">
  2015-09-16
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Android/">Android</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Calls"><span class="post-toc-number">1.</span> <span class="post-toc-text">Calls</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Requests-请求"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">Requests(请求)</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Responses-响应"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">Responses(响应)</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Calls-调用"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">Calls(调用)</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Connections"><span class="post-toc-number">2.</span> <span class="post-toc-text">Connections</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#URLS-统一资源定位符"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">URLS(统一资源定位符)</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Addresses-地址"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">Addresses(地址)</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Routes-路由"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">Routes(路由)</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Connections-连接"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">Connections(连接)</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#示例"><span class="post-toc-number">3.</span> <span class="post-toc-text">示例</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#SynchronousGet"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">SynchronousGet</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Asynchronous-Get"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">Asynchronous Get</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Accessing-Headers"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">Accessing Headers</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Post-String"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">Post String</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Post-Streaming"><span class="post-toc-number">3.5.</span> <span class="post-toc-text">Post Streaming</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Post-File"><span class="post-toc-number">3.6.</span> <span class="post-toc-text">Post File</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Posting-form-parameters"><span class="post-toc-number">3.7.</span> <span class="post-toc-text">Posting form parameters</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Posting-a-multipart-request"><span class="post-toc-number">3.8.</span> <span class="post-toc-text">Posting a multipart request</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Parse-a-JSON-Response-With-Gson"><span class="post-toc-number">3.9.</span> <span class="post-toc-text">Parse a JSON Response With Gson</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Response-Caching"><span class="post-toc-number">3.10.</span> <span class="post-toc-text">Response Caching</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Canceling-a-Call"><span class="post-toc-number">3.11.</span> <span class="post-toc-text">Canceling a Call</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Timeouts"><span class="post-toc-number">3.12.</span> <span class="post-toc-text">Timeouts</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Per-call-Configuration"><span class="post-toc-number">3.13.</span> <span class="post-toc-text">Per-call Configuration</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Handling-authentication"><span class="post-toc-number">3.14.</span> <span class="post-toc-text">Handling authentication</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Interceptors-拦截器"><span class="post-toc-number">4.</span> <span class="post-toc-text">Interceptors(拦截器)</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Application-Interceptors"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">Application Interceptors</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Network-Interceptors"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">Network Interceptors</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#比较"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">比较</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#重写请求头"><span class="post-toc-number">4.4.</span> <span class="post-toc-text">重写请求头</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#重写响应"><span class="post-toc-number">4.5.</span> <span class="post-toc-text">重写响应</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#HTTPS"><span class="post-toc-number">4.6.</span> <span class="post-toc-text">HTTPS</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#总结"><span class="post-toc-number">5.</span> <span class="post-toc-text">总结</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#参考"><span class="post-toc-number">6.</span> <span class="post-toc-text">参考</span></a></li></ol>
        </nav>
    </aside>


<article id="post-OkHttp探索使用"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">OkHttp探索使用</h1>
        <div class="post-meta">
            <time class="post-time" title="2015-09-16 20:12:00" datetime="2015-09-16T12:12:00.000Z"  itemprop="datePublished">2015-09-16</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Android/">Android</a></li></ul>



            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <p>为Android和Java应用设计并且支持SPDY和HTTP请求的客户端。</p>
<h2 id="Calls"><a href="#Calls" class="headerlink" title="Calls"></a>Calls</h2><h3 id="Requests-请求"><a href="#Requests-请求" class="headerlink" title="Requests(请求)"></a><a href="http://square.github.io/okhttp/javadoc/com/squareup/okhttp/Request.html" target="_blank" rel="noopener">Requests(请求)</a></h3><p>每个HTTP请求包含了URL、METHOD和一系列头部信息。当然，头部也可以包含指定类型的数据流。</p>
<h3 id="Responses-响应"><a href="#Responses-响应" class="headerlink" title="Responses(响应)"></a><a href="http://square.github.io/okhttp/javadoc/com/squareup/okhttp/Response.html" target="_blank" rel="noopener">Responses(响应)</a></h3><p>带有状态码，Header和一些可选信息的对请求的响应。</p>
<h3 id="Calls-调用"><a href="#Calls-调用" class="headerlink" title="Calls(调用)"></a><a href="http://square.github.io/okhttp/javadoc/com/squareup/okhttp/Call.html" target="_blank" rel="noopener">Calls(调用)</a></h3><p>调用能够以Synchronous(同步)或者Asynchronous(异步)的形式被执行:</p>
<ul>
<li>Synchronous：请求线程直到响应能够可读时才会释放阻塞；</li>
<li>Asynchronous：请求线程能够将请求进行入队操作，直到响应发生时以回调接口的形式返回。</li>
</ul>
<h2 id="Connections"><a href="#Connections" class="headerlink" title="Connections"></a>Connections</h2><h3 id="URLS-统一资源定位符"><a href="#URLS-统一资源定位符" class="headerlink" title="URLS(统一资源定位符)"></a><a href="http://developer.android.com/reference/java/net/URL.html" target="_blank" rel="noopener">URLS(统一资源定位符)</a></h3><p>URLs对于HTTP和互联网世界来说是至关重要的，除了成为通用的、web世界里唯一命名的解决方案，它们同时也描述了如何获取web资源。</p>
<h3 id="Addresses-地址"><a href="#Addresses-地址" class="headerlink" title="Addresses(地址)"></a><a href="http://square.github.io/okhttp/javadoc/com/squareup/okhttp/Address.html" target="_blank" rel="noopener">Addresses(地址)</a></h3><p>地址描述了一个web服务器和一切对于连接到服务器必要的静态配置信息，比如端口号，HTTPS设置等。共享同一地址的URL同样也共享同一的TCP连接，这样做的好处是：更低的延迟、更高的吞吐量和低消耗电量。OkHttp使用自动重用HTTP/1.x协议的连接和多路复用HTTP/2和SPDY的连接的ConnectionPool（连接池）。</p>
<h3 id="Routes-路由"><a href="#Routes-路由" class="headerlink" title="Routes(路由)"></a><a href="http://square.github.io/okhttp/javadoc/com/squareup/okhttp/Route.html" target="_blank" rel="noopener">Routes(路由)</a></h3><p>路由提供连接到web服务器的必要的动态信息。对于一个地址来说可能存在着多条路由选择。</p>
<h3 id="Connections-连接"><a href="#Connections-连接" class="headerlink" title="Connections(连接)"></a><a href="http://square.github.io/okhttp/javadoc/com/squareup/okhttp/Connection.html" target="_blank" rel="noopener">Connections(连接)</a></h3><p>如果使用OkHttp进行请求的话，它会这么做：<br><a id="more"></a></p>
<ol>
<li>使用给出的URL和配置好的OkHttpClient产生一个Address，这个Address描述了我们如何连接到web服务器；</li>
<li>试图从ConnectionPool(连接池)重新获得一个连接；</li>
<li>如果在连接池找不到连接，它将尝试选择一条路由信息。这也意味着会产生一个DNS请求以便获取真实的服务器IP地址，然后选择TLS版本以及必要时代理服务器的相关信息；</li>
<li>如果是新的路由，它将会通过Socket进行直接连接或者TLS隧道，必要时会进行握手，进行连接；</li>
<li>发送HTTP请求并获得响应信息。<br>一旦响应成功接收到后，连接会被加入到连接池中以便后续的复用，但如果长时间的不使用的后，连接也会从连接池中丢弃。</li>
</ol>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><h3 id="SynchronousGet"><a href="#SynchronousGet" class="headerlink" title="SynchronousGet"></a><a href="https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/com/squareup/okhttp/recipes/SynchronousGet.java" target="_blank" rel="noopener">SynchronousGet</a></h3><p>同步Get请求，响应中的<code>string()</code>方法很方便地让响应以String的形式返回，但数据量大于1M的时候，优先使用Stream。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">      .url(<span class="string">"http://publicobject.com/helloworld.txt"</span>)</span><br><span class="line">      .build();</span><br><span class="line">  Response response = client.newCall(request).execute();</span><br><span class="line">  <span class="keyword">if</span> (!response.isSuccessful()) <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Unexpected code "</span> + response);</span><br><span class="line">  Headers responseHeaders = response.headers();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; responseHeaders.size(); i++) &#123;</span><br><span class="line">    System.out.println(responseHeaders.name(i) + <span class="string">": "</span> + responseHeaders.value(i));</span><br><span class="line">  &#125;</span><br><span class="line">  System.out.println(response.body().string());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Asynchronous-Get"><a href="#Asynchronous-Get" class="headerlink" title="Asynchronous Get"></a><a href="https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/com/squareup/okhttp/recipes/AsynchronousGet.java" target="_blank" rel="noopener">Asynchronous Get</a></h3><p>在工作线程上下载文件，当响应可读的时候获取回调接口。回调接口是在响应的头部信息准备好时便准备完毕了，此时直接读取响应的信息可能会导致阻塞。目前的OkHttp版本暂未提供异步的APi去解析接收Response。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">      .url(<span class="string">"http://publicobject.com/helloworld.txt"</span>)</span><br><span class="line">      .build();</span><br><span class="line">  client.newCall(request).enqueue(<span class="keyword">new</span> Callback() &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Request request, Throwable throwable)</span> </span>&#123;</span><br><span class="line">      throwable.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Response response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (!response.isSuccessful()) <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Unexpected code "</span> + response);</span><br><span class="line">      Headers responseHeaders = response.headers();</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; responseHeaders.size(); i++) &#123;</span><br><span class="line">        System.out.println(responseHeaders.name(i) + <span class="string">": "</span> + responseHeaders.value(i));</span><br><span class="line">      &#125;</span><br><span class="line">      System.out.println(response.body().string());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Accessing-Headers"><a href="#Accessing-Headers" class="headerlink" title="Accessing Headers"></a><a href="https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/com/squareup/okhttp/recipes/AccessHeaders.java" target="_blank" rel="noopener">Accessing Headers</a></h3><p>显而易见地，HTTP的头部信息与Map这种数据结构是很相似的，每一个key对应着一个value，但有些头部允许着多个value，比如Guava的Multimap,对于这些情况，OkHttp同时都支持的。<br>当写入请求头部信息的时候，使用header(name,value)来设置唯一的键值。如果有存在着对应的值，在新的值设置好之前旧的值会被移除掉。可以考虑使用addHeaeder(name,value)来使得一个key对应着多个值。<br>当读取响应体的头部信息时，可以使用header(name)来获取最后一个设置的值。通常来说这也是唯一的引用，但是如果没有对应的值的话，会返回null。在读取多值对应一键的情况下时，使用headerss(name)来以List的形式来获取其值。<br>如果想获取所有的头部，可以考虑使用Headers类通过索引来获取每一个头。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">      .url(<span class="string">"https://api.github.com/repos/square/okhttp/issues"</span>)</span><br><span class="line">      .header(<span class="string">"User-Agent"</span>, <span class="string">"OkHttp Headers.java"</span>)</span><br><span class="line">      .addHeader(<span class="string">"Accept"</span>, <span class="string">"application/json; q=0.5"</span>)</span><br><span class="line">      .addHeader(<span class="string">"Accept"</span>, <span class="string">"application/vnd.github.v3+json"</span>)</span><br><span class="line">      .build();</span><br><span class="line">  Response response = client.newCall(request).execute();</span><br><span class="line">  <span class="keyword">if</span> (!response.isSuccessful()) <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Unexpected code "</span> + response);</span><br><span class="line">  System.out.println(<span class="string">"Server: "</span> + response.header(<span class="string">"Server"</span>));</span><br><span class="line">  System.out.println(<span class="string">"Date: "</span> + response.header(<span class="string">"Date"</span>));</span><br><span class="line">  System.out.println(<span class="string">"Vary: "</span> + response.headers(<span class="string">"Vary"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Post-String"><a href="#Post-String" class="headerlink" title="Post String"></a><a href="https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/com/squareup/okhttp/recipes/PostString.java" target="_blank" rel="noopener">Post String</a></h3><p>当POST请求的字符串数据小于1MB的时候，推荐使用这种方式请求。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> MediaType MEDIA_TYPE_MARKDOWN</span><br><span class="line">      = MediaType.parse(<span class="string">"text/x-markdown; charset=utf-8"</span>);</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String postBody = <span class="string">""</span></span><br><span class="line">        + <span class="string">"Releases\n"</span></span><br><span class="line">        + <span class="string">"--------\n"</span></span><br><span class="line">        + <span class="string">"\n"</span></span><br><span class="line">        + <span class="string">" * _1.0_ May 6, 2013\n"</span></span><br><span class="line">        + <span class="string">" * _1.1_ June 15, 2013\n"</span></span><br><span class="line">        + <span class="string">" * _1.2_ August 11, 2013\n"</span>;</span><br><span class="line">    Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">        .url(<span class="string">"https://api.github.com/markdown/raw"</span>)</span><br><span class="line">        .post(RequestBody.create(MEDIA_TYPE_MARKDOWN, postBody))</span><br><span class="line">        .build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    <span class="keyword">if</span> (!response.isSuccessful()) <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Unexpected code "</span> + response);</span><br><span class="line">    System.out.println(response.body().string());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Post-Streaming"><a href="#Post-Streaming" class="headerlink" title="Post Streaming"></a><a href="https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/com/squareup/okhttp/recipes/PostStreaming.java" target="_blank" rel="noopener">Post Streaming</a></h3><p>当以流的形式进行POST请求时，请求体的内容已经生成了就如同被写入了一样。下面的例子中使用了Okio的缓冲池。但一般情况下我们会使用OutputStream，我们可以使用BufferedSink.outputStream()来获取。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> MediaType MEDIA_TYPE_MARKDOWN</span><br><span class="line">     = MediaType.parse(<span class="string">"text/x-markdown; charset=utf-8"</span>);</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   RequestBody requestBody = <span class="keyword">new</span> RequestBody() &#123;</span><br><span class="line">     <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> MediaType <span class="title">contentType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> MEDIA_TYPE_MARKDOWN;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeTo</span><span class="params">(BufferedSink sink)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">       sink.writeUtf8(<span class="string">"Numbers\n"</span>);</span><br><span class="line">       sink.writeUtf8(<span class="string">"-------\n"</span>);</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt;= <span class="number">997</span>; i++) &#123;</span><br><span class="line">         sink.writeUtf8(String.format(<span class="string">" * %s = %s\n"</span>, i, factor(i)));</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="function"><span class="keyword">private</span> String <span class="title">factor</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt; n; i++) &#123;</span><br><span class="line">         <span class="keyword">int</span> x = n / i;</span><br><span class="line">         <span class="keyword">if</span> (x * i == n) <span class="keyword">return</span> factor(x) + <span class="string">" × "</span> + i;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> Integer.toString(n);</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;;</span><br><span class="line">   Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">       .url(<span class="string">"https://api.github.com/markdown/raw"</span>)</span><br><span class="line">       .post(requestBody)</span><br><span class="line">       .build();</span><br><span class="line">   Response response = client.newCall(request).execute();</span><br><span class="line">   <span class="keyword">if</span> (!response.isSuccessful()) <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Unexpected code "</span> + response);</span><br><span class="line">   System.out.println(response.body().string());</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Post-File"><a href="#Post-File" class="headerlink" title="Post File"></a><a href="https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/com/squareup/okhttp/recipes/PostFile.java" target="_blank" rel="noopener">Post File</a></h3><p>使用文件作为请求体是很容易的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> MediaType MEDIA_TYPE_MARKDOWN</span><br><span class="line">      = MediaType.parse(<span class="string">"text/x-markdown; charset=utf-8"</span>);</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    File file = <span class="keyword">new</span> File(<span class="string">"README.md"</span>);</span><br><span class="line">    Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">        .url(<span class="string">"https://api.github.com/markdown/raw"</span>)</span><br><span class="line">        .post(RequestBody.create(MEDIA_TYPE_MARKDOWN, file))</span><br><span class="line">        .build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    <span class="keyword">if</span> (!response.isSuccessful()) <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Unexpected code "</span> + response);</span><br><span class="line">    System.out.println(response.body().string());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Posting-form-parameters"><a href="#Posting-form-parameters" class="headerlink" title="Posting form parameters"></a><a href="https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/com/squareup/okhttp/recipes/PostForm.java" target="_blank" rel="noopener">Posting form parameters</a></h3><p>使用FormEncodingBuilder来构造一个可以像HTML中<form>标签的请求体。键值对会与HTML相适应地特性从URL中进行编码。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   RequestBody formBody = <span class="keyword">new</span> FormEncodingBuilder()</span><br><span class="line">       .add(<span class="string">"search"</span>, <span class="string">"Jurassic Park"</span>)</span><br><span class="line">       .build();</span><br><span class="line">   Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">       .url(<span class="string">"https://en.wikipedia.org/w/index.php"</span>)</span><br><span class="line">       .post(formBody)</span><br><span class="line">       .build();</span><br><span class="line">   Response response = client.newCall(request).execute();</span><br><span class="line">   <span class="keyword">if</span> (!response.isSuccessful()) <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Unexpected code "</span> + response);</span><br><span class="line">   System.out.println(response.body().string());</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></form></p>
<h3 id="Posting-a-multipart-request"><a href="#Posting-a-multipart-request" class="headerlink" title="Posting a multipart request"></a><a href="https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/com/squareup/okhttp/recipes/PostForm.java" target="_blank" rel="noopener">Posting a multipart request</a></h3><p><code>MultipartBuilder</code>可以用来构造复杂的请求体，每一部分都是一个请求体，并且可以自定义头部信息。如果存在的话，请求体的头部信息应该描述请求的内容，比如Content-Disposition。当然如果Content-Length与Content-Type存在的话，会自动加入到请求的头部当中。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String IMGUR_CLIENT_ID = <span class="string">"..."</span>;</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> MediaType MEDIA_TYPE_PNG = MediaType.parse(<span class="string">"image/png"</span>);</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   <span class="comment">// Use the imgur image upload API as documented at https://api.imgur.com/endpoints/image</span></span><br><span class="line">   RequestBody requestBody = <span class="keyword">new</span> MultipartBuilder()</span><br><span class="line">       .type(MultipartBuilder.FORM)</span><br><span class="line">       .addPart(</span><br><span class="line">           Headers.of(<span class="string">"Content-Disposition"</span>, <span class="string">"form-data; name=\"title\""</span>),</span><br><span class="line">           RequestBody.create(<span class="keyword">null</span>, <span class="string">"Square Logo"</span>))</span><br><span class="line">       .addPart(</span><br><span class="line">           Headers.of(<span class="string">"Content-Disposition"</span>, <span class="string">"form-data; name=\"image\""</span>),</span><br><span class="line">           RequestBody.create(MEDIA_TYPE_PNG, <span class="keyword">new</span> File(<span class="string">"website/static/logo-square.png"</span>)))</span><br><span class="line">       .build();</span><br><span class="line">   Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">       .header(<span class="string">"Authorization"</span>, <span class="string">"Client-ID "</span> + IMGUR_CLIENT_ID)</span><br><span class="line">       .url(<span class="string">"https://api.imgur.com/3/image"</span>)</span><br><span class="line">       .post(requestBody)</span><br><span class="line">       .build();</span><br><span class="line">   Response response = client.newCall(request).execute();</span><br><span class="line">   <span class="keyword">if</span> (!response.isSuccessful()) <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Unexpected code "</span> + response);</span><br><span class="line">   System.out.println(response.body().string());</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Parse-a-JSON-Response-With-Gson"><a href="#Parse-a-JSON-Response-With-Gson" class="headerlink" title="Parse a JSON Response With Gson"></a><a href="https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/com/squareup/okhttp/recipes/ParseResponseWithGson.java" target="_blank" rel="noopener">Parse a JSON Response With Gson</a></h3><p>GSON是一个很方便的API用来转换JSON和Java对象，需要的注意的是ResponseBody.charStream方法默认使用UTF-8编码进行解码，如果有必要的话请设置Content-Type。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">        .url(<span class="string">"https://api.github.com/gists/c2a7c39532239ff261be"</span>)</span><br><span class="line">        .build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    <span class="keyword">if</span> (!response.isSuccessful()) <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Unexpected code "</span> + response);</span><br><span class="line">    Gist gist = gson.fromJson(response.body().charStream(), Gist.class);</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, GistFile&gt; entry : gist.files.entrySet()) &#123;</span><br><span class="line">      System.out.println(entry.getKey());</span><br><span class="line">      System.out.println(entry.getValue().content);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Gist</span> </span>&#123;</span><br><span class="line">    Map&lt;String, GistFile&gt; files;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">GistFile</span> </span>&#123;</span><br><span class="line">    String content;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Response-Caching"><a href="#Response-Caching" class="headerlink" title="Response Caching"></a><a href="https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/com/squareup/okhttp/recipes/CacheResponse.java" target="_blank" rel="noopener">Response Caching</a></h3><p>但需要缓存的时候，应该指定用来进行缓存的目录，缓存目录一般只是用来给自己进行读写的，而非让任意应用进行缓存。多个缓存访问同一个缓存目录是一种错误的做法，如果需要多个缓存应该使用多个<code>OkHttpClient</code>实例去设置多个缓存目录，否则可能会造成应用崩溃。当然有一种更简洁的做法是直接在头部信息里面设置Cache-Control:max-age=9600来允许缓存。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> OkHttpClient client;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">CacheResponse</span><span class="params">(File cacheDirectory)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   <span class="keyword">int</span> cacheSize = <span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span>; <span class="comment">// 10 MiB</span></span><br><span class="line">   Cache cache = <span class="keyword">new</span> Cache(cacheDirectory, cacheSize);</span><br><span class="line">   client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">   client.setCache(cache);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">       .url(<span class="string">"http://publicobject.com/helloworld.txt"</span>)</span><br><span class="line">       .build();</span><br><span class="line">   Response response1 = client.newCall(request).execute();</span><br><span class="line">   <span class="keyword">if</span> (!response1.isSuccessful()) <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Unexpected code "</span> + response1);</span><br><span class="line">   String response1Body = response1.body().string();</span><br><span class="line">   System.out.println(<span class="string">"Response 1 response:          "</span> + response1);</span><br><span class="line">   System.out.println(<span class="string">"Response 1 cache response:    "</span> + response1.cacheResponse());</span><br><span class="line">   System.out.println(<span class="string">"Response 1 network response:  "</span> + response1.networkResponse());</span><br><span class="line">   Response response2 = client.newCall(request).execute();</span><br><span class="line">   <span class="keyword">if</span> (!response2.isSuccessful()) <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Unexpected code "</span> + response2);</span><br><span class="line">   String response2Body = response2.body().string();</span><br><span class="line">   System.out.println(<span class="string">"Response 2 response:          "</span> + response2);</span><br><span class="line">   System.out.println(<span class="string">"Response 2 cache response:    "</span> + response2.cacheResponse());</span><br><span class="line">   System.out.println(<span class="string">"Response 2 network response:  "</span> + response2.networkResponse());</span><br><span class="line">   System.out.println(<span class="string">"Response 2 equals Response 1? "</span> + response1Body.equals(response2Body));</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>为了防止响应使用缓存，可以通过设置<code>CacheControl.FORCE_NETWORK</code>来强制使用网络，当然也可以设置<code>CacheControl.FORCE_CACHE</code>来强制使用缓存而不使用网络。但值得注意的地方就是，在强制使用缓存的时候，然而响应需要使用网络，此时会返回504 Unsatisfiable Request错误。</p>
<h3 id="Canceling-a-Call"><a href="#Canceling-a-Call" class="headerlink" title="Canceling a Call"></a><a href="https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/com/squareup/okhttp/recipes/CancelCall.java" target="_blank" rel="noopener">Canceling a Call</a></h3><p>使用<code>Call.cancell</code>来立即取消正在进行的请求。如果此时正在进行请求或者读取响应时，执行该操作会导致IOException。在不需要进行请求的时候才进行cancel的请求，比如已经离开了应用，此时所有异步和同步的请求都可以取消。<br>一种简便的方法是使用tag参数，构造请求的时候使用<code>RequestBuilder.tag(tag)</code>，在取消的时候使用<code>OkHttpClient.cancel(tag)</code>。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService executor = Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">        .url(<span class="string">"http://httpbin.org/delay/2"</span>) <span class="comment">// This URL is served with a 2 second delay.</span></span><br><span class="line">        .build();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> startNanos = System.nanoTime();</span><br><span class="line">    <span class="keyword">final</span> Call call = client.newCall(request);</span><br><span class="line">    <span class="comment">// Schedule a job to cancel the call in 1 second.</span></span><br><span class="line">    executor.schedule(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.printf(<span class="string">"%.2f Canceling call.%n"</span>, (System.nanoTime() - startNanos) / <span class="number">1e9f</span>);</span><br><span class="line">        call.cancel();</span><br><span class="line">        System.out.printf(<span class="string">"%.2f Canceled call.%n"</span>, (System.nanoTime() - startNanos) / <span class="number">1e9f</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, <span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      System.out.printf(<span class="string">"%.2f Executing call.%n"</span>, (System.nanoTime() - startNanos) / <span class="number">1e9f</span>);</span><br><span class="line">      Response response = call.execute();</span><br><span class="line">      System.out.printf(<span class="string">"%.2f Call was expected to fail, but completed: %s%n"</span>,</span><br><span class="line">          (System.nanoTime() - startNanos) / <span class="number">1e9f</span>, response);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      System.out.printf(<span class="string">"%.2f Call failed as expected: %s%n"</span>,</span><br><span class="line">          (System.nanoTime() - startNanos) / <span class="number">1e9f</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Timeouts"><a href="#Timeouts" class="headerlink" title="Timeouts"></a><a href="https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/com/squareup/okhttp/recipes/ConfigureTimeouts.java" target="_blank" rel="noopener">Timeouts</a></h3><p>超时的问题可以使用<code>OkHttpClient</code>来进行设置读取、连接的超时时间。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> OkHttpClient client;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">ConfigureTimeouts</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">   client.setConnectTimeout(<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">   client.setWriteTimeout(<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">   client.setReadTimeout(<span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">       .url(<span class="string">"http://httpbin.org/delay/2"</span>) <span class="comment">// This URL is served with a 2 second delay.</span></span><br><span class="line">       .build();</span><br><span class="line">   Response response = client.newCall(request).execute();</span><br><span class="line">   System.out.println(<span class="string">"Response completed: "</span> + response);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Per-call-Configuration"><a href="#Per-call-Configuration" class="headerlink" title="Per-call Configuration"></a><a href="https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/com/squareup/okhttp/recipes/PerCallSettings.java" target="_blank" rel="noopener">Per-call Configuration</a></h3><p>可以使用已经配置好的请求来克隆其配置，同时单独配置其他信息。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">        .url(<span class="string">"http://httpbin.org/delay/1"</span>) <span class="comment">// This URL is served with a 1 second delay.</span></span><br><span class="line">        .build();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      OkHttpClient cloned = client.clone(); <span class="comment">// Clone to make a customized OkHttp for this request.</span></span><br><span class="line">      cloned.setReadTimeout(<span class="number">500</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">      Response response = cloned.newCall(request).execute();</span><br><span class="line">      System.out.println(<span class="string">"Response 1 succeeded: "</span> + response);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      System.out.println(<span class="string">"Response 1 failed: "</span> + e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      OkHttpClient cloned = client.clone(); <span class="comment">// Clone to make a customized OkHttp for this request.</span></span><br><span class="line">      cloned.setReadTimeout(<span class="number">3000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">      Response response = cloned.newCall(request).execute();</span><br><span class="line">      System.out.println(<span class="string">"Response 2 succeeded: "</span> + response);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      System.out.println(<span class="string">"Response 2 failed: "</span> + e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Handling-authentication"><a href="#Handling-authentication" class="headerlink" title="Handling authentication"></a><a href="https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/com/squareup/okhttp/recipes/Authenticate.java" target="_blank" rel="noopener">Handling authentication</a></h3><p>OKHttp对于未认证的请求失败时会进行自动重试，当发生了401错误时，使用Authenticator来设置相关认证信息，在构造新的请求的时候应该去包括缺失的认证信息，如果不存在的时候设置null便好。<br>可以使用<code>Response.challenges()</code>来获取相关认证信息，但已经实现了一个基本的认证信息时，只需要使用Credentials.basic(username,password来加密请求头便好。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  client.setAuthenticator(<span class="keyword">new</span> Authenticator() &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Request <span class="title">authenticate</span><span class="params">(Proxy proxy, Response response)</span> </span>&#123;</span><br><span class="line">      System.out.println(<span class="string">"Authenticating for response: "</span> + response);</span><br><span class="line">      System.out.println(<span class="string">"Challenges: "</span> + response.challenges());</span><br><span class="line">      String credential = Credentials.basic(<span class="string">"jesse"</span>, <span class="string">"password1"</span>);</span><br><span class="line">      <span class="keyword">return</span> response.request().newBuilder()</span><br><span class="line">          .header(<span class="string">"Authorization"</span>, credential)</span><br><span class="line">          .build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Request <span class="title">authenticateProxy</span><span class="params">(Proxy proxy, Response response)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>; <span class="comment">// Null indicates no attempt to authenticate.</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">      .url(<span class="string">"http://publicobject.com/secrets/hellosecret.txt"</span>)</span><br><span class="line">      .build();</span><br><span class="line">  Response response = client.newCall(request).execute();</span><br><span class="line">  <span class="keyword">if</span> (!response.isSuccessful()) <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Unexpected code "</span> + response);</span><br><span class="line">  System.out.println(response.body().string());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>为了避免多次重试造成的认证无法正常工作的情况，可以选择返回nulll。当然也可以像下面一样的处理方式来处理认证失败的情况：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (credential.equals(response.request().header(<span class="string">"Authorization"</span>))) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>; <span class="comment">// If we already failed with these credentials, don't retry.</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>同时也可以指定重试次数：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (responseCount(response) &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>; <span class="comment">// If we've failed 3 times, give up.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>重试次数的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">responseCount</span><span class="params">(Response response)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span> ((response = response.priorResponse()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">    result++;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Interceptors-拦截器"><a href="#Interceptors-拦截器" class="headerlink" title="Interceptors(拦截器)"></a><a href="">Interceptors(拦截器)</a></h2><p>拦截器是一种用来进行监控，重写，重试和重新调用的强大机制。下面是一种简单的实现，只是用来简单的LOG输出。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoggingInterceptor</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Request request = chain.request();</span><br><span class="line">    <span class="keyword">long</span> t1 = System.nanoTime();</span><br><span class="line">    logger.info(String.format(<span class="string">"Sending request %s on %s%n%s"</span>,</span><br><span class="line">        request.url(), chain.connection(), request.headers()));</span><br><span class="line">    Response response = chain.proceed(request);</span><br><span class="line">    <span class="keyword">long</span> t2 = System.nanoTime();</span><br><span class="line">    logger.info(String.format(<span class="string">"Received response for %s in %.1fms%n%s"</span>,</span><br><span class="line">        response.request().url(), (t2 - t1) / <span class="number">1e6</span>d, response.headers()));</span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>chain.proceed(request)</code>该调用方法是每个拦截器实现的关键部分，看起来简单的方法事实上完成了所有的HTTP调用与处理流程。<br>拦截器也是能够被链接起来的，假设同时拥有压缩的拦截器和校验的拦截器，这里需要确定何时进行校验，何时进行压缩。OkHttp会使用列表进行跟踪，确保拦截器的有序执行。拦截器的允许机制如下图所示：<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="okhttp_interceptors.png" alt="拦截器运行机制" title="">
                </div>
                <div class="image-caption">拦截器运行机制</div>
            </figure><br>由图可以看到的是，拦截器存在着两种工作域，全局的拦截器和网络拦截器。</p>
<h3 id="Application-Interceptors"><a href="#Application-Interceptors" class="headerlink" title="Application Interceptors"></a>Application Interceptors</h3><p>下面使用LoginInterceptor来对上面两种拦截器进行区分。使用<code>OkHttpClient.interceptors()</code>获取拦截器列表，然后使用add方法进行新的拦截器的添加。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">client.interceptors().add(<span class="keyword">new</span> LoggingInterceptor());</span><br><span class="line">Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">    .url(<span class="string">"http://www.publicobject.com/helloworld.txt"</span>)</span><br><span class="line">    .header(<span class="string">"User-Agent"</span>, <span class="string">"OkHttp Example"</span>)</span><br><span class="line">    .build();</span><br><span class="line">Response response = client.newCall(request).execute();</span><br><span class="line">response.body().close();</span><br></pre></td></tr></table></figure></p>
<p>假设存在着重定向的链接，Application级别的拦截器只会被调用一次，即请求时的Sending…和最后返回的</p>
<h3 id="Network-Interceptors"><a href="#Network-Interceptors" class="headerlink" title="Network Interceptors"></a>Network Interceptors</h3><p>使用网络层级别的拦截器与上面的很相似，只不过在获取系统拦截器列表的操作<code>interceptors()</code>换成了<code>networkInterceptors()</code>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">client.networkInterceptors().add(<span class="keyword">new</span> LoggingInterceptor());</span><br><span class="line">Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">    .url(<span class="string">"http://www.publicobject.com/helloworld.txt"</span>)</span><br><span class="line">    .header(<span class="string">"User-Agent"</span>, <span class="string">"OkHttp Example"</span>)</span><br><span class="line">    .build();</span><br><span class="line">Response response = client.newCall(request).execute();</span><br><span class="line">response.body().close();</span><br></pre></td></tr></table></figure></p>
<p>对于已存在的重定向的链接，Network级别的拦截器会被调用多次，对应着多个Sending ..和Received..。</p>
<h3 id="比较"><a href="#比较" class="headerlink" title="比较"></a>比较</h3><ul>
<li>Application interceptors<ul>
<li>无需担心中间产生的响应；</li>
<li>尽管HTTP响应是从缓存中获得的，但是总是只会调用一次；</li>
<li>只关心应用原始的意图，对于OkHttp自动注入的头部信息并不关心；</li>
<li>允许短路而且无需调用Chain.proceed()；</li>
<li>允许重试而且通过Chain.proceed()来产生多次调用；</li>
</ul>
</li>
<li>Network interceptors<ul>
<li>能够处理中间产生的相应，比如重定向和重试；</li>
<li>对于网络短路而使用缓存的响应不会被调用；</li>
<li>只关心数据流动正像数据从整个网络传输一样；</li>
<li>能够访问带有请求的Connection对象</li>
</ul>
</li>
</ul>
<h3 id="重写请求头"><a href="#重写请求头" class="headerlink" title="重写请求头"></a>重写请求头</h3><p>拦截器可以任意地添加，移除或者替换，对于存在的头可以随意变换。比如，服务端能够支持压缩的请求流，此时可以在Application interceptor中去处理压缩过程。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** This interceptor compresses the HTTP request body. Many webservers can't handle this! */</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GzipRequestInterceptor</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Request originalRequest = chain.request();</span><br><span class="line">    <span class="keyword">if</span> (originalRequest.body() == <span class="keyword">null</span> || originalRequest.header(<span class="string">"Content-Encoding"</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> chain.proceed(originalRequest);</span><br><span class="line">    &#125;</span><br><span class="line">    Request compressedRequest = originalRequest.newBuilder()</span><br><span class="line">        .header(<span class="string">"Content-Encoding"</span>, <span class="string">"gzip"</span>)</span><br><span class="line">        .method(originalRequest.method(), gzip(originalRequest.body()))</span><br><span class="line">        .build();</span><br><span class="line">    <span class="keyword">return</span> chain.proceed(compressedRequest);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">private</span> RequestBody <span class="title">gzip</span><span class="params">(<span class="keyword">final</span> RequestBody body)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RequestBody() &#123;</span><br><span class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> MediaType <span class="title">contentType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> body.contentType();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">contentLength</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>; <span class="comment">// We don't know the compressed length in advance!</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeTo</span><span class="params">(BufferedSink sink)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        BufferedSink gzipSink = Okio.buffer(<span class="keyword">new</span> GzipSink(sink));</span><br><span class="line">        body.writeTo(gzipSink);</span><br><span class="line">        gzipSink.close();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="重写响应"><a href="#重写响应" class="headerlink" title="重写响应"></a>重写响应</h3><p>既然能够重写请求，那么也可以重写响应。但对于大多数情况下都是不推荐的，因为这回影响返回结果的正确性。不过有时候可以修正某些预先配置错误的信息。比如Cache-Control。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Dangerous interceptor that rewrites the server's cache-control header. */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Interceptor REWRITE_CACHE_CONTROL_INTERCEPTOR = <span class="keyword">new</span> Interceptor() &#123;</span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Response originalResponse = chain.proceed(chain.request());</span><br><span class="line">    <span class="keyword">return</span> originalResponse.newBuilder()</span><br><span class="line">        .header(<span class="string">"Cache-Control"</span>, <span class="string">"max-age=60"</span>)</span><br><span class="line">        .build();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h3 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h3><p>OkHttp尝试平衡下面两个具有竞争性质的点：</p>
<ul>
<li>(Connectivity) 更多版本更全面的连接。</li>
<li>(Security) 更多版本的证书支持。<br>总的来说，尽可能使用新版本的OKHttp使得连接性和安全性都能得到保证。</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>参考Wiki和其他博文，自己总结写了个轻量级的能够更快捷方便的OkHttpUtil，支持多种请求：<br>Github：<a href="https://github.com/hjw541988478/OkHttpTutorial" target="_blank" rel="noopener">https://github.com/hjw541988478/OkHttpTutorial</a></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><blockquote>
<ol>
<li><a href="https://github.com/square/okhttp" target="_blank" rel="noopener">OkHttp</a></li>
<li><a href="https://github.com/square/okhttp/wiki" target="_blank" rel="noopener">OkHttpWiki</a></li>
<li><a href="http://blog.csdn.net/lmj623565791/article/details/47911083" target="_blank" rel="noopener">Android OkHttp完全解析 是时候来了解OkHttp了</a></li>
<li><a href="http://blog.csdn.net/lmj623565791/article/details/48129405" target="_blank" rel="noopener">Android Https相关完全解析 当OkHttp遇到Https</a></li>
</ol>
</blockquote>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        

        
        这里可以写作者留言，标签和 hexo 中所有变量及辅助函数等均可调用，示例：<a href="/OkHttp探索使用/" target="_blank" rel="external">https://hjw541988478.github.io/OkHttp探索使用/</a>
        
    </div>
    
    <footer>
        <a href="https://hjw541988478.github.io">
            <img src="/img/avatar.jpg" alt="Garvin">
            Garvin
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>



        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Okhttp/">Okhttp</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://hjw541988478.github.io/OkHttp探索使用/&title=《OkHttp探索使用》 — Garvin 杂记&pic=https://hjw541988478.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://hjw541988478.github.io/OkHttp探索使用/&title=《OkHttp探索使用》 — Garvin 杂记&source=为Android和Java应用设计并且支持SPDY和HTTP请求的客户端。
CallsRequests(请求)每个HTTP请求包含了URL、METHOD和..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://hjw541988478.github.io/OkHttp探索使用/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《OkHttp探索使用》 — Garvin 杂记&url=https://hjw541988478.github.io/OkHttp探索使用/&via=https://hjw541988478.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://hjw541988478.github.io/OkHttp探索使用/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/IPC通信机制理解实践/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">IPC通信机制理解实践</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/MaterialDesign设计探索使用/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">MaterialDesign设计探索使用</h4>
      </a>
    </div>
  
</nav>



    











    <!-- Valine Comments -->
    <div class="comments vcomment" id="comments"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script>
    <!-- Valine Comments script -->
    <script>
        var GUEST_INFO = ['nick','mail','link'];
        var guest_info = 'nick,mail,link'.split(',').filter(function(item){
          return GUEST_INFO.indexOf(item) > -1
        });
        new Valine({
            el: '#comments',
            notify: 'false' == 'true',
            verify: 'false' == 'true',
            appId: "Av3sk2Q4QhL7up87ziVVSeeS-gzGzoHsz",
            appKey: "hVI7cltsWA2q1fvsUNRWEJ4e",
            avatar: "retro",
            placeholder: "Just go go",
            guest_info: guest_info.length == 0 ? GUEST_INFO : guest_info,
            pageSize: "10"
        })
    </script>
    <!-- Valine Comments end -->







</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        谢谢大爷~
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/wechat.jpg" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="/img/wechat.jpg" data-alipay="/img/alipay.jpg">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>博客内容遵循 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>Garvin &copy; 2015 - 2018</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://hjw541988478.github.io/OkHttp探索使用/&title=《OkHttp探索使用》 — Garvin 杂记&pic=https://hjw541988478.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://hjw541988478.github.io/OkHttp探索使用/&title=《OkHttp探索使用》 — Garvin 杂记&source=为Android和Java应用设计并且支持SPDY和HTTP请求的客户端。
CallsRequests(请求)每个HTTP请求包含了URL、METHOD和..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://hjw541988478.github.io/OkHttp探索使用/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《OkHttp探索使用》 — Garvin 杂记&url=https://hjw541988478.github.io/OkHttp探索使用/&via=https://hjw541988478.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://hjw541988478.github.io/OkHttp探索使用/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACLElEQVR42u3ay46DMBBEUf7/p4mUVaQEU1XtILl9vYoIAQ4j9fTDxyGv872ujpwf6/vI+PjVOcc/FgwYMJZlzLr01W/1FzF+QePrw4ABYwfGOMi6t1QCd+X1wYABA4ab/GUJohKsYcCAAaMScPVkcVZwhwEDBgwlRRsHykph/GgtDgMGjAUZ7mDgyc9/nG/AgAFjEcYZrfok0Q2sN9eEAQNGa4ZblGZp4tzmnf1YMGDAWJyRNetnwSr3/RFqYcCAsQFDhz1zvvFvAAYMGJsx9MvpWyj07RRh4IYBA0ZrRtYgcwFZSLVfHAwYMJoy9IZXpZVWGWRKzwMDBowNGPpgMmuHuaWpHmphwICxA6NScCpB2T2uJJf2OBMGDBgtGEoRm7X4M57bT4MBA0ZvRlY0upu33PLY/QwDBowdGPrIMEv16gH3ZvAAAwaM1ozs4aQgKAffyoDzJsOFAQNGC4bbsnfr47kl8c3fAQYMGE0ZSjzW00Q3QIe72BQMDBgw2jGUgWJWrLo1ps6wHw4GDBjtGG7AdbdKVAaf9mYLGDBgtGDoCaI+PHD3a7kFc/gDGDBgLMg4zeWWr+4gIdw0BgMGjNYMN9jNKmuzIUF9jAEDBox1GVlzX/k2SwrdM2HAgLEPQ9mkpbfGpm2b0EtrGDBgwJA3e7nh271jmL3CgAFjG4YbgivdsMl1NgwYMFow3C0XertfadWVeoEwYMDYgJGFwoztppuVZhwMGDBaMF48kGC+mZ07MwAAAABJRU5ErkJggg==" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };


lazyScripts.push('//s95.cnzz.com/z_stat.php?id=1274482147&web_id=1274482147')

</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>






<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = '';
            clearTimeout(titleTime);
        } else {
            document.title = '';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
